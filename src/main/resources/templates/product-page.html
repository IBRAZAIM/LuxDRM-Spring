<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Страница продукта</title>
    <link rel="stylesheet" th:href="@{/product.css}">
    <link rel="stylesheet" th:href="@{/navbar.css}">
    <link rel="stylesheet" th:href="@{/footer.css}">
    <!--    <link rel="stylesheet" th:href="@{/userPanel.css}">-->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
</head>
<body>
<header>
    <div th:insert="~{navbar :: navigation-panel}" class="navigation-panel"></div>
</header>
<main class="product-container">

    <!-- Product Images Gallery -->
    <div class="product-gallery">
        <div class="main-image-container" id="mainImageContainer">
            <div class="images-wrapper" id="imagesWrapper">
                <!-- Использование Thymeleaf для динамического добавления изображений -->
                <img th:each="image : ${product.images}"
                     th:src="@{${image.image}}"
                     alt="Main Product Image"
                     class="large-img">
            </div>
        </div>
        <div class="thumbnail-column">
            <ul>
                <!-- Генерируем миниатюры для всех изображений -->
                <li th:each="image, iterStat : ${product.images}"
                    onclick="showImageByIndex(this, [[${iterStat:index}]])">
                    <img th:src="@{${image.image}}" alt="Product Thumbnail" class="thumbnail-img">
                </li>
            </ul>
        </div>
    </div>

    <div class="right-column">
        <div class="description-zone">
            <div class="product-top">
                <div class="product-name-container">
                    <span th:text="${product.category.name}" class="category"></span>
                    <div class="product-info" th:if="${product.discount > 0}">
                        <!-- Знак верификации качества -->
                        <div class="quality-verification">
                            <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="30" height="30" viewBox="0 0 48 48">
                                <polygon fill="#42a5f5" points="29.62,3 33.053,8.308 39.367,8.624 39.686,14.937 44.997,18.367 42.116,23.995 45,29.62 39.692,33.053 39.376,39.367 33.063,39.686 29.633,44.997 24.005,42.116 18.38,45 14.947,39.692 8.633,39.376 8.314,33.063 3.003,29.633 5.884,24.005 3,18.38 8.308,14.947 8.624,8.633 14.937,8.314 18.367,3.003 23.995,5.884"></polygon>
                                <polygon fill="#fff" points="21.396,31.255 14.899,24.76 17.021,22.639 21.428,27.046 30.996,17.772 33.084,19.926"></polygon>
                            </svg>
                        </div>
                        <h1 th:text="${product.name}" class="product-name">Название товара</h1>
                        <span class="discount-percentage" th:text="${product.discount + '%'}">Скидка</span>
                    </div>
                    <div class="product-info" th:unless="${product.discount > 0}">
                        <!-- Знак верификации качества -->
                        <div class="quality-verification">
                            <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="30" height="30" viewBox="0 0 48 48">
                                <polygon fill="#42a5f5" points="29.62,3 33.053,8.308 39.367,8.624 39.686,14.937 44.997,18.367 42.116,23.995 45,29.62 39.692,33.053 39.376,39.367 33.063,39.686 29.633,44.997 24.005,42.116 18.38,45 14.947,39.692 8.633,39.376 8.314,33.063 3.003,29.633 5.884,24.005 3,18.38 8.308,14.947 8.624,8.633 14.937,8.314 18.367,3.003 23.995,5.884"></polygon><polygon fill="#fff" points="21.396,31.255 14.899,24.76 17.021,22.639 21.428,27.046 30.996,17.772 33.084,19.926"></polygon>
                            </svg>
                        </div>
                        <h1 th:text="${product.name}" class="product-name">Название товара</h1>
                    </div>
                    <!-- Звезды для рейтинга -->
                    <div class="product-rating">
                        <div class="stars">
                            <span th:each="i : ${#numbers.sequence(1, 5)}" class="star" th:classappend="${i <= (product.rating != null ? (product.rating < 4.0 ? 4.0 : product.rating) : 4.0) ? ' filled' : ''}">&#9733;</span>
                        </div>
                        <!-- Рейтинг в формате 4.0/5.0 -->
                        <span class="rating-value" th:text="${product.rating != null ? (product.rating < 4.0 ? 4.0 : product.rating) : 4.0} + '/5.0'">4.0/5.0</span>
                    </div>
                    <div class="discount" th:if="${product.discount > 0}">
                        <span class="price" th:text="${product.price - product.price * product.discount / 100}" id="formattedDiscountPrice">Цена со скидкой</span>
                        <span class="original-price" th:text="${product.price}" id="formattedOriginalPrice">Цена</span>
                    </div>
                    <div th:unless="${product.discount > 0}">
                        <p th:text="${product.price}" class="price" id="formattedPrice">Цена</p>
                    </div>
                </div>
            </div>
            <div class="product-mobile-image">
                <!--Добавляется div-image-->
            </div>
            <!-- Форма добавления в корзину -->
            <div class="product-bottom">
                <form class="add-to-cart-form" th:action="@{|/cart/${product.getId()}|}" method="post">
                    <div class="sizes-container">
                        <span class="size-label">Размер</span>
                        <div class="sizes-options">
                            <div th:each="size, iterStat : ${sizes}" class="size-option">
                                <div th:text="${size.size}" class="size-label-btn" onclick="selectSize(this, '${size.size}')"></div>
                            </div>
                        </div>
                        <input type="hidden" name="size" id="selected-size">
                    </div>
                    <div class="mobile-add-to-cart">
                        <div class="cart-container">
                            <div class="quantity-block">
                                <label class="quantity">Кол-во</label>
                                <div class="number" data-step="1" data-min="1" data-max="20">
                                    <a class="number-minus" onclick="decrement()">−</a>
                                    <input class="number-text" type="text" name="quantity" value="1">
                                    <a class="number-plus" onclick="increment()">+</a>
                                </div>
                            </div>
                        </div>
                        <div class="add-cart-div">
                            <button type="submit" class="add-to-cart" id="add-to-cart-btn" disabled>Добавить в корзину
                            </button>
                            <span id="size-error" class="size-error" role="alert">Пожалуйста, выберите размер</span>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</main>
<div class="tabs-container">
    <p class="tab-button active" data-tab="description">Описание</p>
    <p class="tab-button" data-tab="characteristics">Характеристики</p>
    <p class="tab-button" data-tab="reviews">Отзывы</p>
</div>
<div class="tab-content">
    <!-- Описание -->
    <div class="tab-section active" id="description-section">
        <p th:text="${product.description}" class="description-text">Product Description</p>
    </div>

    <!-- Характеристики -->
    <div class="tab-section" id="characteristics-section">
        <table class="characteristics-table">
            <thead>
            <tr>
                <th>Характеристика</th>
                <th>Значение</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="entry : ${options}">
                <td th:text="${entry.getKey().getName()}">Характеристика</td>
                <td th:text="${entry.getValue().isPresent() ? entry.getValue().get().name : 'Не указано'}">Значение</td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- Отзывы -->
    <div class="tab-section" id="reviews-section">
        <ul class="reviews-list">
            <li th:each="review : ${reviews}">
                <div class="review-header">
                    <strong th:text="${review.getUser().getName()}">Имя пользователя</strong>
                    <div class="review-rating">
                        <i class="fa-regular fa-star" th:classappend="${review.getEstimation() >= 1 ? ' fa-solid' : ''}"></i>
                        <i class="fa-regular fa-star" th:classappend="${review.getEstimation() >= 2 ? ' fa-solid' : ''}"></i>
                        <i class="fa-regular fa-star" th:classappend="${review.getEstimation() >= 3 ? ' fa-solid' : ''}"></i>
                        <i class="fa-regular fa-star" th:classappend="${review.getEstimation() >= 4 ? ' fa-solid' : ''}"></i>
                        <i class="fa-regular fa-star" th:classappend="${review.getEstimation() == 5 ? ' fa-solid' : ''}"></i>
                    </div>
                </div>
                <p th:text="${review.getText()}" class="comment-text"></p>
            </li>
        </ul>
        <div th:if="${#authorization.expression('isAuthenticated()')}">
            <a id="openModalBtn" class="add-review-btn">Добавить отзыв</a>
        </div>
        <div th:unless="${#authorization.expression('isAuthenticated()')}">
            <p class="login-prompt">Чтобы оставить отзыв необходимо <a th:href="@{/login}">авторизоваться</a></p>
        </div>
    </div>
    <!-- Отзывы -->

</div>
<main class="products-section">
    <section id="product-section">
        <div class="products-section-header">
            <h2 class="products-section-topic">Похожие товары</h2>
        </div>
        <div class="products-section-container">
            <div th:each="product : ${products}" class="products-section-card">
                <a th:href="@{'/products/' + ${product.getId()}}" class="products-section-link">
                    <!-- Скидка сверху -->
                    <div class="discount-znak" th:text="${product.discount != null ? product.discount + '%' : ''}" th:if="${product.discount != null && product.discount > 0}"></div>
                    <img th:src="${product.getImages().get(0).image}" alt="product-img" class="products-section-img">
                    <div class="products-section-info">
                        <p class="products-section-name" th:text="${product.getName()}"></p>
                        <p class="products-section-price" th:text="${product.getPrice()} + ' тг'"></p>
                    </div>
                </a>
            </div>
        </div>
    </section>
</main>

<div id="commentModal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <div th:class="comment-form">
            <h3 class="comment-add-text">Добавить отзыв</h3>
            <form th:action="@{/products/addComment}" method="post" enctype="multipart/form-data">
                <input type="hidden" name="productId" th:value="${product.id}">
                <input type="hidden" name="userId" th:value="${user.id}">
                <div>
                    <label th:for="estimation">Оценка:</label>
                    <div class="star-rating">
                        <input type="radio" name="estimation" id="star5" value="5" required>
                        <label for="star5" title="5 stars"><i class="fa-regular fa-star"></i></label>
                        <input type="radio" name="estimation" id="star4" value="4">
                        <label for="star4" title="4 stars"><i class="fa-regular fa-star"></i></label>
                        <input type="radio" name="estimation" id="star3" value="3">
                        <label for="star3" title="3 stars"><i class="fa-regular fa-star"></i></label>
                        <input type="radio" name="estimation" id="star2" value="2">
                        <label for="star2" title="2 stars"><i class="fa-regular fa-star"></i></label>
                        <input type="radio" name="estimation" id="star1" value="1">
                        <label for="star1" title="1 star"><i class="fa-regular fa-star"></i></label>
                    </div>
                </div>
                <div>
                    <label for="comment">Текст отзыва:</label>
                    <textarea name="comment" id="comment" placeholder="Текст комментария" required></textarea>
                </div>
                <button type="submit">Отправить</button>
            </form>
        </div>
    </div>
</div>
<div th:insert="~{footer :: footer-code}"></div>
<script th:src="@{/js/navbar-component.js}" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        // --- Модальное окно ---
        const modal = document.getElementById("commentModal");
        const openModalBtn = document.getElementById("openModalBtn");
        const closeModalBtn = document.querySelector(".close-btn");

        openModalBtn?.addEventListener("click", () => modal.style.display = "block");
        closeModalBtn?.addEventListener("click", () => modal.style.display = "none");
        window.addEventListener("click", (e) => {
            if (e.target === modal) modal.style.display = "none";
        });

        // --- Счетчик количества ---
        const updateQuantity = (inputSelector, delta) => {
            const input = document.querySelector(inputSelector);
            if (!input) return;
            const value = parseInt(input.value) || 0;
            const min = parseInt(input.parentNode.getAttribute('data-min')) || 0;
            const max = parseInt(input.parentNode.getAttribute('data-max')) || Infinity;

            const newValue = value + delta;
            if (newValue >= min && newValue <= max) input.value = newValue;
        };

        window.increment = () => updateQuantity('.number-text', 1);
        window.decrement = () => updateQuantity('.number-text', -1);

        // --- Форматирование цены ---
        const formatPrice = (price) => price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");

        const priceElements = [
            "formattedDiscountPrice",
            "formattedOriginalPrice",
            "formattedPrice"
        ];

        priceElements.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerText = formatPrice(el.innerText) + " ₸";
        });

        // --- Табы ---
        const buttons = document.querySelectorAll(".tab-button");
        const sections = document.querySelectorAll(".tab-section");

        sections.forEach(section => section.classList.remove("active"));
        document.getElementById("description-section")?.classList.add("active");

        buttons.forEach(button => {
            button.addEventListener("click", () => {
                const tabId = button.getAttribute("data-tab");
                sections.forEach(section => section.classList.remove("active"));
                document.getElementById(`${tabId}-section`)?.classList.add("active");
                buttons.forEach(btn => btn.classList.remove("active"));
                button.classList.add("active");
            });
        });

        // --- Выбор размера ---
        window.selectSize = (element) => {
            const addButton = document.getElementById('add-to-cart-btn');
            const selectedInput = document.getElementById('selected-size');

            if (element.classList.contains('selected')) {
                element.classList.remove('selected');
                selectedInput.value = '';
                addButton.disabled = true;
            } else {
                document.querySelectorAll('.size-label-btn').forEach(size => size.classList.remove('selected'));
                element.classList.add('selected');
                selectedInput.value = element.textContent.trim();
                addButton.disabled = false;
            }
        };

        // --- Проверка формы ---
        const form = document.querySelector('form');
        form?.addEventListener('submit', (e) => {
            const selectedSize = document.getElementById('selected-size')?.value;
            if (!selectedSize) {
                e.preventDefault();
                document.getElementById('size-error').style.display = 'inline';
            }
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const wrapper = document.getElementById('imagesWrapper');
        const slides = wrapper.querySelectorAll('.large-img');
        const thumbnails = document.querySelectorAll('.thumbnail-column li');

        let currentIndex = 0;
        const total = slides.length;

        function showImage(index) {
            if (index < 0) index = 0;
            if (index >= total) index = total - 1;

            currentIndex = index;
            wrapper.style.transform = `translateX(-${index * 100}%)`;

            thumbnails.forEach(t => t.classList.remove('active'));
            if (thumbnails[index]) thumbnails[index].classList.add('active');
        }

        thumbnails.forEach((thumb, index) => {
            thumb.addEventListener('click', () => showImage(index));
        });

        let startX = 0;
        const container = document.getElementById('mainImageContainer');

        container.addEventListener('touchstart', e => {
            startX = e.touches[0].clientX;
        });

        container.addEventListener('touchend', e => {
            const endX = e.changedTouches[0].clientX;
            if (endX < startX - 50) showImage(currentIndex + 1);
            if (endX > startX + 50) showImage(currentIndex - 1);
        });

        document.addEventListener('keydown', e => {
            if (e.key === "ArrowRight") showImage(currentIndex + 1);
            if (e.key === "ArrowLeft") showImage(currentIndex - 1);
        });

        showImage(0);
    });
</script>
<script>
    window.addEventListener("DOMContentLoaded", () => {
        if (window.innerWidth <= 780) {
            const gallery = document.querySelector('.product-gallery');
            const rightColumn = document.querySelector('.product-mobile-image');
            if (gallery && rightColumn) {
                // Перемещаем галерею в самый низ правой колонки
                rightColumn.appendChild(gallery);
            }
        }
    });
</script>
<script>
    // Регистрируем визит при заходе на страницу
    fetch('/analytics/register', { method: 'GET' });
</script>
</body>
</html>